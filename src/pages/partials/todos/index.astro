---
export const partial = true

import { db, Todo } from 'astro:db'
import crypto from 'crypto'

import TodoItem from '../../../components/Todo.astro'

const createNewTodo = (text: string) => ({
  id: crypto.randomUUID(),
  text,
  completed: false
})

let insertedTodo = null

if(Astro.request.method === 'POST') {
  const data = await Astro.request.formData()
  const newTodo = createNewTodo(data.get('text') as string)

  insertedTodo = await db.insert(Todo).values(newTodo).returning().then((res) => res[0])
}

---

<TodoItem todo={insertedTodo!} />

