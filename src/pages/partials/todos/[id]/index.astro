---
export const partial = true

import { db, Todo, eq } from 'astro:db'
import TodoItem from '../../../../components/Todo.astro'

let updatedTodo

if(Astro.request.method === 'DELETE') {
  const { id } = Astro.params
  await db.delete(Todo).where(eq(Todo.id, String(id)))
  return Astro.redirect('/', 303)
}

if(Astro.request.method === 'PATCH') {
  const { id } = Astro.params
  updatedTodo = await db.update(Todo).set({ completed: true }).where(eq(Todo.id, String(id))).returning().then((todos) => todos[0])
}
---

{Astro.request.method === 'PATCH' ? <TodoItem todo={updatedTodo!} /> : null}
